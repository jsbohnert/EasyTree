!function($){$.fn.easytree=function(options){var jQueryContext=this,easyTree=new EasyTree(jQueryContext,options);return easyTree};var EasyTree=function(jQueryContext,options){function nodeClick(event){var id=getElementId(this),nodes=event.data,node=getNode(nodes,id);if(node&&(unactivateAll(nodes),_settings.allowActivate&&(node.isActive=!0,$("#"+node.id).addClass("easytree-active"),_settings.stateChanged))){var j=getMinifiedJson(nodes);_settings.stateChanged(nodes,j)}}function toggleNodeEvt(event){var id=getElementId(this),nodes=event.data,node=getNode(nodes,id);node&&toggleNodeBegin(event,nodes,node)}function toggleNodeBegin(event,nodes,node){var ret="";if(_settings.toggling&&(ret=_settings.toggling(event,nodes,node),ret===!1))return!1;if(node.isExpanded){if(_settings.closing&&(ret=_settings.closing(event,nodes,node),ret===!1))return!1}else if(_settings.opening&&(ret=_settings.opening(event,nodes,node),ret===!1))return!1;if(node.isLazy&&!node.isExpanded){var hasChildren=node.children&&node.children.length>0;if(ret=!0,_settings.openLazyNode&&(ret=_settings.openLazyNode(event,nodes,node,hasChildren)),node.lazyUrl&&ret!==!1)return ajaxService(node.lazyUrl,node.lazyUrlJson,function(data){data.d&&(data=data.d);var json=convertInputDataToJson(data);$.isArray(json)?node.children=json:(node.children=[],node.children.push(json)),buildTree(nodes),toggleNodeEnd(event,nodes,node)}),!1}toggleNodeEnd(event,nodes,node)}function toggleNodeEnd(event,nodes,node){if(node.isExpanded?(openCloseNode(nodes,node.id,"close"),renderNode(node,"close"),_settings.closed&&_settings.closed(event,nodes,node)):(openCloseNode(nodes,node.id,"open"),renderNode(node,"open"),_settings.opened&&_settings.opened(event,nodes,node)),_settings.toggled){_settings.toggled(event,nodes,node)}}function dragStart(event){if(_settings.enableDnd){for(var el=event.target;el&&!(el.className.indexOf("easytree-draggable")>-1);)el=el.parentElement;if(el)return unsourceAll(_nodes),unactivateAll(_nodes),$("#"+el.id).addClass("easytree-drag-source"),resetDnd(_dnd),_dnd.createClone=!(el.className.indexOf("easytree-no-clone")>-1),_dnd.dragok=!0,_dnd.sourceEl=el,_dnd.sourceId=el.id,_dnd.sourceNode=getNode(_nodes,_dnd.sourceId),!1}}function drag(event){if(_dnd.dragok&&_settings.enableDnd){_dnd.createClone&&(_dnd.clone||(_dnd.clone=createClone(_dnd.sourceEl),$(_dnd.clone).appendTo("body")),_dnd.clone.style.left=event.pageX+5+"px",_dnd.clone.style.top=event.pageY+"px");var targetEl=getDroppableTargetEl(event.clientX,event.clientY);if(!targetEl)return hideDragHelpers(),_dnd.targetEl=null,_dnd.targetId=null,_dnd.targetNode=null,void(_dnd.canDrop=!1);if(targetEl.id!=_dnd.targetId){_dnd.canDrop=!1,window.clearTimeout(_dnd.openDelayTimeout),_dnd.targetEl=targetEl,_dnd.targetId=targetEl.id,_dnd.targetNode=getNode(_nodes,_dnd.targetId),log("source:"+(_dnd.sourceNode&&_dnd.sourceNode.text?_dnd.sourceNode.text:_dnd.sourceId)),log("target:"+(_dnd.targetNode&&_dnd.targetNode.text?_dnd.targetNode.text:_dnd.targetId)),log("isAncester:"+isAncester(_dnd.sourceNode,_dnd.targetId));var $target=$("#"+_dnd.targetId);if(isAncester(_dnd.sourceNode,_dnd.targetId))return void showRejectDragHelper();if(_dnd.targetId==_dnd.sourceId)return void hideDragHelpers();if(_settings.canDrop){var isSourceNode=null!=_dnd.sourceNode,source=isSourceNode?_dnd.sourceNode:_dnd.sourceEl,isTargetNode=null!=_dnd.targetNode,target=isTargetNode?_dnd.targetNode:_dnd.targetEl,ret=_settings.canDrop(event,_nodes,isSourceNode,source,isTargetNode,target);if(ret===!0)return showAcceptDragHelper(),_dnd.canDrop=!0,void(_dnd.openDelayTimeout=window.setTimeout(function(){openCloseNode(_nodes,_dnd.targetId,"open"),renderNode(_dnd.targetNode,"open")},600));if(ret===!1)return void showRejectDragHelper()}return $target.hasClass("easytree-reject")?showRejectDragHelper():$target.hasClass("easytree-accept")?(showAcceptDragHelper(),_dnd.canDrop=!0,_dnd.openDelayTimeout=window.setTimeout(function(){openCloseNode(_nodes,_dnd.targetId,"open"),renderNode(_dnd.targetNode,"open")},600)):hideDragHelpers(),!1}}}function dragEnd(event){var isSourceNode=null!=_dnd.sourceNode,source=isSourceNode?_dnd.sourceNode:_dnd.sourceEl,isTargetNode=null!=_dnd.targetNode,target=isTargetNode?_dnd.targetNode:_dnd.targetEl,canDrop=_dnd.canDrop;if(hideDragHelpers(),$("#_st_clone_").remove(),null===source||null===target)return resetDnd(_dnd),!1;if(_settings.dropping){var ret=_settings.dropping(event,_nodes,isSourceNode,source,isTargetNode,target,canDrop);if(ret===!1)return void resetDnd(_dnd)}return _dnd.targetNode&&_dnd.sourceNode&&canDrop&&(_dnd.targetNode.children||(_dnd.targetNode.children=[]),removeNode(_nodes,_dnd.sourceId),_dnd.targetNode.children.push(_dnd.sourceNode)),canDrop&&(_settings.dropped&&_settings.dropped(event,_nodes,isSourceNode,source,isTargetNode,target),buildTree(_nodes)),resetDnd(_dnd),!1}function createClone(sourceEl){$(sourceEl).remove(".easytree-expander");var clone=$(sourceEl).clone().remove(".easytree-expander").removeClass("easytree-drag-source")[0],firstChild=clone.children[0];return firstChild&&"easytree-expander"==firstChild.className&&clone.removeChild(firstChild),clone.style.display="block",clone.style.position="absolute",clone.style.opacity=.5,clone.id="_st_clone_",clone.style.zIndex=1e3,clone}function getDroppableTargetEl(clientX,clientY){for(var targetEl=document.elementFromPoint(clientX,clientY);targetEl;){if(targetEl.className.indexOf("easytree-droppable")>-1)return targetEl;targetEl=targetEl.parentElement}return null}function resetDnd(dnd){dnd.canDrop=!1,dnd.createClone=!0,dnd.clone=null,dnd.dragok=!1,dnd.openDelayTimeout=null,dnd.targetEl=null,dnd.targetId=null,dnd.targetNode=null,dnd.sourceEl=null,dnd.sourceId=null,dnd.sourceNode=null}function getElementId(el){for(;null!=el;){if(el.id)return el.id;el=el.parentElement}return null}function getNode(nodes,id){var i=0;for(i=0;i<nodes.length;i++){var n=nodes[i];n.text;if(n.id==id)return n;var hasChildren=n.children&&n.children.length>0;if(hasChildren){var node=getNode(n.children,id);if(node)return node}}return null}function isAncester(node,id){var i=0;if(!node||!node.children||0==node.children.length)return!1;for(i=0;i<node.children.length;i++){var n=node.children[i];n.text;if(n.id==id)return!0;var hasChildren=n.children&&n.children.length>0;if(hasChildren){var ancester=isAncester(n,id);if(ancester)return ancester}}return!1}function removeNode(nodes,id){var i=0;for(i=0;i<nodes.length;i++){var n=nodes[i];n.text;if(n.id==id)return void nodes.splice(i,1);var hasChildren=n.children&&n.children.length>0;hasChildren&&removeNode(n.children,id)}}function openCloseNode(nodes,id,openOrClose){var i=0;for(i=0;i<nodes.length;i++){var n=nodes[i];n.text;if(n.id==id)return void(n.isExpanded="open"==openOrClose);var hasChildren=n.children&&n.children.length>0;hasChildren&&openCloseNode(n.children,id,openOrClose)}}function unactivateAll(nodes,nodesOnly){var i=0;for(i=0;i<nodes.length;i++){var n=nodes[i];n.isActive=!1,nodesOnly||$("#"+n.id).closest("ul").find(".easytree-active").removeClass("easytree-active");var hasChildren=n.children&&n.children.length>0;hasChildren&&unactivateAll(n.children,!0)}}function unsourceAll(nodes){var i=0;for(i=0;i<nodes.length;i++){var n=nodes[i];$("#"+n.id).removeClass("easytree-drag-source");var hasChildren=n.children&&n.children.length>0;hasChildren&&unsourceAll(n.children)}}function sort(nodes){var i=0;for(nodes=nodes.sort(function(n1,n2){var n1Text=n1.text.toLowerCase(),n2Text=n2.text.toLowerCase();n1Text||(n1Text="a"),n2Text||(n2Text="a"),_settings.ordering.toLowerCase().indexOf("folder")>-1&&n1.isFolder&&(n1Text="______"+n1Text),_settings.ordering.toLowerCase().indexOf("folder")>-1&&n2.isFolder&&(n2Text="______"+n2Text);var reverse=-1==_settings.ordering.indexOf(" DESC")?1:-1;return n2Text>n1Text?-1*reverse:n1Text>n2Text?1*reverse:0}),i=0;i<nodes.length;i++){var n=nodes[i],hasChildren=n.children&&n.children.length>0;hasChildren&&sort(n.children)}return nodes}function giveUniqueIds(nodes,level,id){var i=0;for(level||(level=0,id="_st_node_"+id+"_"),i=0;i<nodes.length;i++){var n=nodes[i];n.id||(n.id=id+i.toString());var hasChildren=n.children&&n.children.length>0;hasChildren&&giveUniqueIds(n.children,level+1,id+i+"_")}}function buildTree(nodes){if(nodes){new Date;if(_settings.building){var ret=_settings.building(nodes);if(ret===!1)return!1}new Date;_settings.ordering&&(nodes=sort(nodes));var uniqueId=(new Date,Math.floor(1e4*Math.random()));giveUniqueIds(nodes,0,uniqueId);new Date;_nodes=nodes;var html=getNodesAsHtml(nodes,0,!0);new Date;$this[0].innerHTML=html;new Date;$($this.selector+" .easytree-node").on("click",nodes,nodeClick),$($this.selector+" .easytree-expander").on("click",nodes,toggleNodeEvt),$($this.selector+" .easytree-icon").on("dblclick",nodes,toggleNodeEvt),$($this.selector+" .easytree-title").on("dblclick",nodes,toggleNodeEvt);new Date;_settings.enableDnd&&($(document).on("mousedown",dragStart),$(document).on("mousemove",drag),$(document).on("mouseup",dragEnd));new Date;_settings.built&&_settings.built(nodes);new Date;if(_settings.stateChanged){var j=getMinifiedJson(nodes);_settings.stateChanged(nodes,j)}new Date}}function getNodesAsHtml(nodes,level,display){var html="",i=0,ulCss="";0==level&&(ulCss+="ui-easytree easytree-container easytree-focused");var forceOpenNode=level<_settings.minOpenLevels,ulStyle=0==level||display||forceOpenNode?"":" style='display:none' ";for(html+='<ul tabindex="0" class="'+ulCss+'" '+ulStyle+'">',i=0;i<nodes.length;i++){var n=nodes[i];forceOpenNode===!0&&(n.isExpanded=!0);var lastSibling=i==nodes.length-1,spanCss=getSpanCss(n,lastSibling);html+="<li>",html+='<span id="'+n.id+'" class="'+spanCss+' ">',html+=forceOpenNode?"":'<span class="easytree-expander"></span>',html+=getIconHtml(n),html+=getTitleHtml(n),html+="</span>",n.children&&n.children.length>0&&(html+=getNodesAsHtml(n.children,level+1,n.isExpanded)),html+="</li>"}return html+="</ul>"}function getSpanCss(node,lastSibling){var spanCss=(node.children&&node.children.length>0,"easytree-node ");_settings.enableDnd&&(spanCss+=" easytree-draggable "),node.liClass&&(spanCss+=node.liClass),node.isFolder&&_settings.enableDnd?spanCss+=" easytree-droppable easytree-accept ":_settings.enableDnd&&(spanCss+=" easytree-droppable easytree-reject "),node.isActive&&_settings.allowActivate&&(spanCss+=" easytree-active "),spanCss+=getExpCss(node,lastSibling);var ico=node.isExpanded?"e":"c";return node.isFolder&&(ico+="f"),spanCss+=" easytree-ico-"+ico}function getExpCss(node,lastSibling){var hasChildren=node.children&&node.children.length>0,exp="";return exp=!hasChildren&&node.isLazy?"c":hasChildren?node.isExpanded?"e":"c":"n",lastSibling&&(exp+="l")," easytree-exp-"+exp}function getIconHtml(node){var html="";return _settings.disableIcons?html:node.uiIcon?'<span class="easytree-custom-icon ui-icon '+node.uiIcon+'"></span>':node.iconUrl?'<span><img src="'+node.iconUrl+'" /></span>':'<span class="easytree-icon"></span>'}function getTitleHtml(node){var html="",tooltip=node.tooltip?'title="'+node.tooltip+'"':"",titleCss="easytree-title";return node.textCss&&(titleCss+=" "+node.textCss),html+="<span "+tooltip+' class="'+titleCss+'">',node.href&&(html+='<a href="'+node.href+'" ',node.hrefTarget&&(html+=' target="'+node.hrefTarget+'" '),html+=">"),html+=node.text,node.href&&(html+="</a>"),html+="</span>"}function renderNode(node,openOrClose){if(node){var classes=$("#"+node.id).attr("class"),expClassStart=classes.indexOf("easytree-exp-");if(expClassStart>-1){var expClassEnd=classes.indexOf(" ",expClassStart),expClass=expClassEnd>-1?classes.substring(expClassStart,expClassEnd):classes.substring(expClassStart);$("#"+node.id).removeClass(expClass),$("#"+node.id).addClass(getExpCss(node,!1))}var parentLi=$("#"+node.id).parents("li").first(),childUl=parentLi.children("ul").first(),slideTime=parseInt(_settings.slidingTime,10);"close"==openOrClose?childUl.slideUp(slideTime):childUl.slideDown(slideTime)}}function hideDragHelpers(){$("#easytree-reject").hide(),$("#easytree-accept").hide()}function showAcceptDragHelper(){$("#easytree-accept").show(),$("#easytree-reject").hide()}function showRejectDragHelper(){$("#easytree-reject").show(),$("#easytree-accept").hide()}function getMinifiedJson(nodes){for(var j=JSON.stringify?JSON.stringify(nodes):"Please import json2.js";j.indexOf(',"children":[]')>-1;)j=j.replace(',"children":[]',"");for(;j.indexOf('"liClass":"",')>-1;)j=j.replace('"liClass":"",',"");for(;j.indexOf('"textCss":"",')>-1;)j=j.replace('"textCss":"",',"");for(;j.indexOf('"isExpanded":false,')>-1;)j=j.replace('"isExpanded":false,',"");for(;j.indexOf('"isActive":false,')>-1;)j=j.replace('"isActive":false,',"");for(;j.indexOf('"isFolder":false,')>-1;)j=j.replace('"isFolder":false,',"");for(;j.indexOf('"isLazy":false,')>-1;)j=j.replace('"isLazy":false,',"");return j}function init(){initDragHelpers(),resetDnd(_dnd),$(document).on("mousemove",function(event){var top=event.pageY,left=event.pageX;document.getElementById("easytree-reject").style.top=top+10+"px",document.getElementById("easytree-reject").style.left=left+17+"px",document.getElementById("easytree-accept").style.top=top+10+"px",document.getElementById("easytree-accept").style.left=left+17+"px"})}function initDragHelpers(){if(!$("#easytree-reject").length){var dragRejectHtml='<div id="easytree-reject" class="easytree-drag-helper easytree-drop-reject">';dragRejectHtml+='<span class="easytree-drag-helper-img"></span>',dragRejectHtml+="</div>",$("body").append(dragRejectHtml)}if(!$("#easytree-accept").length){var dragAcceptHtml='<div id="easytree-accept" class="easytree-drag-helper easytree-drop-accept">';dragAcceptHtml+='<span class="easytree-drag-helper-img"></span>',dragAcceptHtml+="</div>",$("body").append(dragAcceptHtml)}}function ajaxService(actionUrl,json,callBack){$.ajax({url:actionUrl,type:"POST",contentType:"application/json; charset=utf-8",data:json,success:callBack,error:function(jqXHR,textStatus,errorThrown){alert("Error: "+jqXHR.responseText)}})}function convertInputDataToJson(data){var json=null;return"object"==typeof data?json=data:"string"==typeof data&&(data=$.trim(data),json=0==data.indexOf("[")||0==data.indexOf("{")?$.parseJSON(data):convertHtmlToJson(data)),json}function convertHtmlToJson(html){var $html=$(html),nodes=[];$html.children().each(function(index){nodes.push(convertHtmlToNode(this))});return nodes}function convertHtmlToNode(element){var $el=$(element),node={},data=$el.data();node.isActive=$el.hasClass("isActive"),$el.removeClass("isActive"),node.isFolder=$el.hasClass("isFolder"),$el.removeClass("isFolder"),node.isExpanded=$el.hasClass("isExpanded"),$el.removeClass("isExpanded"),node.isLazy=$el.hasClass("isLazy"),$el.removeClass("isLazy"),node.uiIcon=data.uiicon,node.liClass=$el.attr("class"),node.id=$el.attr("id");var $a=$el.children("a");$a&&(node.href=$a.attr("href"),node.hrefTarget=$a.attr("target"));var $img=$el.children("img");$img&&(node.iconUrl=$img.attr("src")),node.textCss="";var $span=$el.children("span");$span&&$span.attr("class")&&(node.textCss+=$span.attr("class")+" "),$span=$a.children("span"),$span&&$span.attr("class")&&(node.textCss+=$span.attr("class")+" "),$span=$img.children("span"),$span&&$span.attr("class")&&(node.textCss+=$span.attr("class")+" "),node.text=getNodeValue($el[0]),node.tooltip=$el.attr("title"),node.children=[];$el.children("ul").children("li").each(function(index){node.children.push(convertHtmlToNode(this))});return node}function getNodeValue(el){var i=0;for(i=0;i<el.childNodes.length;i++)for(var child=el.childNodes[i];child;){if(3==child.nodeType&&$.trim(child.nodeValue).length>0)return $.trim(child.nodeValue);child=child.firstChild}return""}function log(message){message||(message="null"),console.log(message)}var $this,_settings={allowActivate:!0,data:null,dataUrl:null,dataUrlJson:null,disableIcons:!1,enableDnd:!1,ordering:null,slidingTime:100,minOpenLevels:0,building:null,built:null,toggling:null,toggled:null,opening:null,opened:null,openLazyNode:null,closing:null,closed:null,canDrop:null,dropping:null,dropped:null,stateChanged:null},_nodes=null,_dnd=new Object;this.init=function(jQueryContext,options){_settings=$.extend(_settings,options),init(),$this=jQueryContext;var json="";if(_settings.dataUrl)ajaxService(_settings.dataUrl,_settings.dataUrlJson,function(data){return(json=convertInputDataToJson(data))?(buildTree(json),this):(alert("EasyTree: Invalid data!"),this)});else if(_settings.data){if(json=convertInputDataToJson(_settings.data),!json)return alert("EasyTree: Invalid data!"),this;buildTree(json)}else{if(json=convertInputDataToJson($this.html()),!json)return alert("EasyTree: Invalid data!"),this;buildTree(json)}return this},this.options=_settings,this.rebuildTree=function(data){var json=data?convertInputDataToJson(data):_nodes;json||alert("EasyTree: Invalid data!"),buildTree(json)},this.getAllNodes=function(){return _nodes},this.getNode=function(id){return getNode(_nodes,id)},this.addNode=function(sourceNode,targetId){if(!targetId)return void _nodes.push(sourceNode);var targetNode=getNode(_nodes,targetId);sourceNode&&(targetNode.children||(targetNode.children=[]),targetNode.children.push(sourceNode))},this.removeNode=function(id){removeNode(_nodes,id)},this.activateNode=function(id){if(unactivateAll(_nodes),_settings.allowActivate){var node=getNode(_nodes,id);node&&(node.isActive=!0,$("#"+node.id).addClass("easytree-active"))}},this.toggleNode=function(id){var node=getNode(_nodes,id);node&&toggleNodeBegin(event,_nodes,node)},this.init(jQueryContext,options)}}(jQuery);